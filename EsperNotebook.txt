//%esperepl
create schema Mascota(idcollar integer, nombre string, especie string, raza string, estado string);
create schema Localizacion(idcollar integer, nombre string, area string, permitida string);
create schema Pulsaciones (idcollar integer, nombre string, valor int, estado string);
create schema Respiraciones (idcollar integer, nombre string, valor int, estado string);
create schema Temperatura (idcollar integer, nombre string, valor int);
create schema Comedero (idcomedero int, idcollar int, estado string, reserva string);
create schema Clinica (nombre string, ubicacion string);

create constant variable integer PULMAX = 150;
create constant variable integer PULMIN = 60;

create constant variable integer TEMPMAX = 150;
create constant variable integer TEMPMIN = 60;

create constant variable integer RESPMAX = 40;
create constant variable integer RESPMIN = 10;

@Name('AlertaPulsaciones')
insert into AlertaPulsaciones
select  p1.idcollar as idcollar, p1.nombre as NomMascota, p1.valor as Pul1, p2.valor as Pul2, p1.estado as Estado
from pattern [every ( p1 = Pulsaciones(p1.valor > PULMAX or p1.valor < PULMIN) or (p1 = Pulsaciones() -> p2 = Pulsaciones(Math.abs(p2.valor - p1.valor) >= 40 and p1.idcollar = p2.idcollar))) where timer:within(15 seconds)];

@Name('AlertaRespiraciones')
insert into AlertaRespiraciones
select  r1.idcollar as idcollar, r1.nombre as NomMascota, r1.valor as Resp1, r2.valor as Resp2, r1.estado as Estado
from pattern [every ( r1 = Respiraciones(r1.valor > RESPMAX or r1.valor < RESPMIN) or (r1= Respiraciones() -> r2 = Respiraciones(Math.abs(r2.valor - r1.valor) >= 25 and r1.idcollar = r2.idcollar))) where timer:within(15 seconds)];

@Name('AlertaTemperatura')
insert into AlertaTemperatura
select  t1.idcollar as idcollar, t1.nombre as NomMascota, t1.valor as Temp1, t2.valor as Temp2
from pattern [every ( t1 = Temperatura(t1.valor > TEMPMAX or t1.valor < TEMPMIN) or (t1= Temperatura() -> t2 = Temperatura(Math.abs(t2.valor - t1.valor) >= 1.5 and t1.idcollar = t2.idcollar))) where timer:within(15 seconds)];

@Name('ComederoVacio')
insert into ComederoVacio
select c.idcomedero
from pattern [every c = Comedero (estado = 'Vacio' and reserva = 'Vacia')];

@Name('ZonaDesconocida')
insert into ZonaDesconocida
select *
from pattern [every l = Localizacion (permitida = 'No')];

@Name('Huida')
insert into Huida
select l.idcollar, l.nombre, l.area
from pattern [every l = Localizacion(permitida = 'No') -> p1 = Pulsaciones(idcollar = l.idcollar) -> p2 = Pulsaciones(idcollar = l.idcollar, (valor - p1.valor)/p1.valor > 0.40) where timer:within(10 seconds)];

@Name('ActividadAnormal')
insert into ActividadAnormal
select p.Pul1 as Pulsaciones, r.Resp1 as Respiraciones, p.Estado as Estado, p.idcollar as Collar, p.NomMascota as NomMascota from pattern [every (p = AlertaPulsaciones(p.Estado = 'Inactivo') -> r = AlertaRespiraciones(r.Estado = 'Inactivo' and r.idcollar = p.idcollar)) where timer:within(5 seconds)];

@Name('ProblemaSalud')
insert into ProblemaSalud
select p.idcollar, p.NomMascota
from pattern [every p = AlertaPulsaciones -> t = AlertaTemperatura(idcollar = p.idcollar) ->r = AlertaRespiraciones(idcollar = p.idcollar) where timer:within(20 seconds)];

@Name('AlertaComedero')
insert into AlertaComedero
select c.idcollar, c.estado as EstadoComedero
from pattern [every c = Comedero(estado != 'Vacio') -> timer:interval(11 minutes) and not Comedero(idcollar = c.idcollar, estado = 'Vacio')];

@Name('AvisarDueno')
insert into AvisarDueno
select "Mensaje Enviado al dueño" as Mensaje
from pattern [every (Huida or ZonaDesconocida or AlertaComedero or ComederoVacio or AlertaPulsaciones or AlertaTemperatura or AlertaRespiraciones)];

@Name('AvisarVeterinaria')
insert into AvisarVeterinaria
select  "Mensaje Enviado a la clínica" as Mensaje, c.nombre as Nombre
from pattern [every (ProblemaSalud or ActividadAnormal) -> c = Clinica ];

//%esperescenario

// Mascotas
Mascota = {idcollar = 1, nombre = "Manoli", especie = "Perro", raza = "Labrador", estado = "activo"}
Mascota = {idcollar = 2, nombre = "Kaki", especie = "Perro", raza = "Beagle", estado = "activo"}
Mascota = {idcollar = 3, nombre = "Agustín", especie = "Gato", raza = "siames", estado = "inactivo"}
Mascota = {idcollar = 4, nombre = "Bolita", especie = "Gato", raza = "Persa", estado = "inactivo"}

//Manoli inactivo, valores bajos 
Pulsaciones={idcollar=1, nombre="Manoli", valor=45, estado="inactivo"}
Respiraciones={idcollar=1, nombre="Manoli", valor=8, estado="inactivo"}
Temperatura={idcollar=1, nombre="Manoli", valor=36}

//Agustín zona no permitida, pulsaciones normales
Localizacion={idcollar=2, nombre="Agustín", area="Calle", permitida="no"}
Pulsaciones={idcollar=2, nombre="Agustín", valor=60, estado="inactivo"}
Respiraciones={idcollar=2, nombre="Agustín", valor=12, estado="inactivo"}
Temperatura={idcollar=2, nombre="Agustín", valor=38}

//Kaki activo
Localizacion={idcollar=3, nombre="Kaki", area="Casa", permitida="si"}
Pulsaciones={idcollar=3, nombre="Kaki", valor=120, estado="activo"}
Respiraciones={idcollar=3, nombre="Kaki", valor=20, estado="activo"}
Temperatura={idcollar=3, nombre="Kaki", valor=39}

//Bolita zona no permitida, pulsaciones altas
Localizacion={idcollar=4, nombre="Bolita", area="Jardín", permitida="no"}
Pulsaciones={idcollar=4, nombre="Bolita", valor=190, estado="activo"}
Respiraciones={idcollar=4, nombre="Bolita", valor=45, estado="activo"}
Temperatura={idcollar=4, nombre="Bolita", valor=41}


Comedero={idcomedero=1, idcollar=1, estado="lleno", reserva="si"}
Comedero={idcomedero=2, idcollar=2, estado="medio", reserva="si"}
Comedero={idcomedero=3, idcollar=3, estado="vacio", reserva="no"}  // vacio sin reserva
Comedero={idcomedero=4, idcollar=4, estado="medio", reserva="no"}  

//Manoli permanece inactiva
Pulsaciones={idcollar=1, nombre="Manoli", valor=48, estado="inactivo"}
Respiraciones={idcollar=1, nombre="Manoli", valor=9, estado="inactivo"}

//Agustín huida 
Pulsaciones={idcollar=2, nombre="Agustín", valor=110, estado="activo"}
Respiraciones={idcollar=2, nombre="Agustín", valor=20, estado="activo"}

//Bolita sigue huyendo
Pulsaciones={idcollar=4, nombre="Bolita", valor=200, estado="activo"}
Respiraciones={idcollar=4, nombre="Bolita", valor=50, estado="activo"}

//Comedero de Bolita sin cambios
Comedero={idcomedero=4, idcollar=4, estado="medio", reserva="no"}

//Manoli permanece inactiva
Pulsaciones={idcollar=1, nombre="Manoli", valor=46, estado="inactivo"}
Respiraciones={idcollar=1, nombre="Manoli", valor=8, estado="inactivo"}
Temperatura={idcollar=1, nombre="Manoli", valor=36}

//Nombre de las clínicas
Clinica = {nombre="AnimalitosBonitos", ubicacion="Puertas del sur"}
Clinica = {nombre="Vet+", ubicacion="El altillo"}