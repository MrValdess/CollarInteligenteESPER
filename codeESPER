create schema Mascota(idcollar integer, nombre string, especie string, raza string, estado string);

create schema Localizacion(idcollar integer, nombre string, area string, permitida string);

create schema Pulsaciones (idcollar integer, nombre string, valor int, estado string);

create schema Respiraciones (idcollar integer, nombre string, valor int, estado string);

create schema Temperatura (idcollar integer, nombre string, valor int);

create schema Comedero (idcomedero int, idcollar int, estado string, reserva string);

create schema Clinica (nombre string, ubicacion string);

//por minuto
create constant variable integer PULMAX = 150;
create constant variable integer PULMIN = 60;

create constant variable integer TEMPMAX = 150;
create constant variable integer TEMPMIN = 60;

//por minuto
create constant variable integer RESPMAX = 40;
create constant variable integer RESPMIN = 10;

@Name('AlertaPulsaciones')
insert into AlertaPulsaciones
select  p1.idcollar as idcollar, p1.nombre as NomMascota, p1.valor as Pul1, p2.valor as Pul2
from pattern [every ( p1 = Pulsaciones(p1.valor > PULMAX or p1.valor < PULMIN) or (p1 = Pulsaciones() -> p2 = Pulsaciones(Math.abs(p2.valor - p1.valor) >= 40 and p1.idcollar = p2.idcollar))) where timer:within(15 seconds)];

@Name('AlertaRespiraciones')
insert into AlertaRespiraciones
select  r1.idcollar as idcollar, r1.nombre as NomMascota, r1.valor as Resp1, r2.valor as Resp2
from pattern [every ( r1 = Respiraciones(r1.valor > RESPMAX or r1.valor < RESPMIN) or (r1= Respiraciones() -> r2 = Respiraciones(Math.abs(r2.valor - r1.valor) >= 25 and r1.idcollar = r2.idcollar))) where timer:within(15 seconds)];

@Name('AlertaTemperatura')
insert into AlertaTemperatura
select  t1.idcollar as idcollar, t1.nombre as NomMascota, t1.valor as Temp1, t2.valor as Temp2
from pattern [every ( t1 = Temperatura(t1.valor > TEMPMAX or t1.valor < TEMPMIN) or (t1= Temperatura() -> t2 = Temperatura(Math.abs(t2.valor - t1.valor) >= 1.5 and t1.idcollar = t2.idcollar))) where timer:within(15 seconds)];

@Name('ComederoVacio')
insert into ComederoVacio
select c.idcomedero
from pattern [every c = Comedero (estado = 'vacio' and reserva = 'no')];

@Name('ZonaDesconocida')
insert into ZonaDesconocida
select * 
from pattern [every l = Localizacion (permitida = 'no')];

@Name('Huida')
insert into Huida
select l.idcollar, l.nombre, l.area
from pattern [every l = Localizacion(permitida = 'no') -> p1 = Pulsaciones(idcollar = l.idcollar) -> p2 = Pulsaciones(idcollar = l.idcollar, (valor - p1.valor)/p1.valor > 0.40) where timer:within(10 seconds)];

@Name('InactividadProlongada')
insert into InactividadProlongada
select p.valor as Pulsaciones, r.valor as Respiraciones, m.estado as Estado, p.idcollar as Collar, p.nombre as NomMascota
from pattern [every (p = Pulsaciones(valor < 50) and r = Respiraciones(valor < 10, idcollar = p.idcollar) and m = Mascota(estado = 'INACTIVO', idcollar = p.idcollar)) where timer:within(5 seconds)];

@Name('ProblemaSalud')
insert into ProblemaSalud
select p.idcollar, p.NomMascota
from pattern [every p = AlertaPulsaciones -> t = AlertaTemperatura(idcollar = p.idcollar) ->r = AlertaRespiraciones(idcollar = p.idcollar) where timer:within(20 seconds)];

@Name('AlertaComedero')
insert into AlertaComedero
select c.idcollar, c.estado as EstadoComedero
from pattern [every c = Comedero(estado != 'VACIO') -> timer:interval(10 minutes) and not Comedero(idcollar = c.idcollar, estado = 'VACIO')];

@Name('EstadoComedero')
insert into EstadoComedero
select c.idCollar, c.estado as EstadoActual
from pattern [ every c = (AlertaComedero or ComederoVacio) ];

@Name('AvisarVeterinaria')
insert into AvisarVeterinaria
select a.nombre
from pattern [ every a = (ProblemaSalud or InactividadProlongada) ];

@Name('AvisarDueño')
insert into AvisarDueño
select a.nombre
from pattern [ every a = (Huida or ZonaDesconocida or AlertaComedero or ComederoVacio or EstadoComedero or AlertaPulsaciones or AlertaTemperatura or AlertaRespiraciones) ];
