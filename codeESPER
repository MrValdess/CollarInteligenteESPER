%esperepl

create schema Mascota(idcollar integer, nombre string, especie string, raza string, estado string);

create schema Localizacion(idcollar integer, nombre string, area string, permitida string);

create schema Pulsaciones (idcollar integer, nombre string, valor int, estado string);

create schema Respiracion (idcollar integer, nombre string, valor int, estado string);

create schema Temperatura (idcollar integer, nombre string, valor int);

create schema Comedero (idcomedero int, idcollar int, estado string, reserva string);

create schema Clinica (nombre string, ubicacion string);

//por minuto
create constant variable integer PULMAX = 150;
create constant variable integer PULMIN = 60;

create constant variable integer TEMPMAX = 150;
create constant variable integer TEMPMIN = 60;

//por minuto
create constant variable integer RESPMAX = 40;
create constant variable integer RESPMIN = 10;

//no funcionaaaaaaaa
@Name('AlertaPulsaciones')
insert into AlertaPulsaciones
select p1.valor as Pul1, p2.valor as Pul2
from pattern [every p1 = Pulsaciones(valor > PULMAX or valor < PULMIN) or p1 -> p2 = Pulsaciones ((Math.abs(p2.valor-p1.valor) > 40) and (p1.idcollar = p2.idcollar)) where timer:within (15 seconds)];
@Name('AlertaRespiraciones')
@Name('AlertaTemperatura')
@Name('AlertaComedero')
insert into AlertaComedero
select c.idcollar
from pattern [every c = Comedero (estado != 'vacio') ->(timer:interval (10 minutes) and not Comedero(idcollar = c.idcollar estado = 'vacio'))];

@Name('ComederoVacio')
insert into ComederoVacio
select idcomedero
from [every c = Comedero (estado = 'vacio' and reserva = 'no')];

@Name('ZonaDesconocida')
insert into ZonaDesconocida
select * 
from pattern [every l = Localizacion (permitida = 'no')];

@Name('Huida')
insert into Huida
select l.collar, l.nombre, l.area
from pattern [every l = Localizacion (permitida = 'no') and p1 = Pulsaciones(idCollar = l.idCollar) -> p2 = Pulsaciones(idCollar = l.idCollar and (p2.valor - p1.valor)/p1.valor > 0.40 ) where timer:within(10 seconds)];

@Name('InactividadProlongada')
@Name('ProblemaSalud')
@Name('RecepciónAlerta')
@Name('AvisarVeterinaria')
@Name('AvisarDueño')
